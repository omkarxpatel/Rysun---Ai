<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rysun Ai Project - Omkar Patel</title>
    <!-- tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone/babel.min.js"></script>
</head>

<body class="bg-gray-100">
    <div id="root"></div>
    <script type="text/babel">
        function App() {
            const [error, setError] = React.useState(null);
            const [promptValue, setPromptValue] = React.useState('');
            const [aiResult, setAiResult] = React.useState('');
            const [selectedModel, setSelectedModel] = React.useState('');
            const [lastPrompt, setLastPrompt] = React.useState('');
            const [lastModel, setLastModel] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [serverStatus, setServerStatus] = React.useState(false);

            React.useEffect(() => {
                const checkServerStatus = () => {
                    fetch('http://127.0.0.1:5000/api/status')
                        .then(response => {
                            if (response.ok) {
                                setServerStatus(true);
                            } else {
                                setServerStatus(false);
                            }
                        })
                        .catch(error => {
                            setServerStatus(false);
                            console.error('Error checking server status:', error);
                        });
                };

                checkServerStatus();
                const intervalId = setInterval(checkServerStatus, 5000);

                return () => clearInterval(intervalId);
            }, []);

            const handleModelChange = (e) => {
                const selectedValue = e.target.value;

                fetch('http://127.0.0.1:5000/api/model-dropdown-selected', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ selectedOption: selectedValue }),
                })
                .then(response => response.json())
                .then(data => {
                    setAiResult('')
                    setError(null)
                    setSelectedModel(data['model']);
                    console.log('Dropdown selection response:', data);
                })
                .catch(error => console.error('Error calling dropdown selection API:', error));
            };

            const handlePromptChange = (e) => {
                setPromptValue(e.target.value);

                if (error) {
                    setError(null)
                }
            };

            const handlePromptSubmit = (e) => {
                e.preventDefault();

                console.log('Form submitted with user input:', promptValue);

                if (promptValue == '') setError("Please enter a prompt")
                else if (promptValue == lastPrompt && selectedModel == lastModel) setError("Please enter a new prompt or change models")
                else {
                    setLoading(true);
                    setLastModel(selectedModel)
                    setLastPrompt(promptValue)
                    setError(null)
                    fetch('http://127.0.0.1:5000/api/prompt-submission', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ prompt: promptValue, model: selectedModel }),
                    })
                    .then(response => response.json())
                    .then(responseData => {
                        if (responseData['response'] == 'Please select a model') setError("Please select a model")
                        else if (responseData['response'].substring(0,6) == "Error:") setError(responseData['response'] )
                        else setAiResult(responseData);
                        console.log('API response:', responseData);
                    })
                    .catch(error => {
                        console.error('Error calling prompt submission API:', error);
                        setError(error);
                    })
                    .finally(() => {
                        setLoading(false);
                    });
                }
            };


            return (
                <div className="container mx-auto mt-8 p-4 bg-white shadow-md rounded-lg">
                    <h1 className="text-2xl font-bold mb-4 text-center border-b-2 border-gray-300 pb-2">Rysun Ai Project - Omkar Patel</h1>

                    <div className="mt-4 text-center">
                        {serverStatus ? (
                            <div className="text-green-500 font-semibold">Server is connected.</div>
                        ) : (
                            <div className="text-red-500 font-semibold">Server is not connected.</div>
                        )}
                    </div>
                    <hr className="my-4" />

                    <div className="flex">
                        <div className="w-1/4">
                            {/* Left-aligned section */}
                            <div className="bg-gray-200 p-4 rounded-lg">
                                <div className="mb-4 border-b-2 border-gray-300 pb-2">
                                    <h3 className="text-lg font-semi bold text-center">Select your AI model</h3>
                                    <select
                                        className="bg-gray-300 text-gray-700 font-semibold py-2 px-2 rounded w-full"
                                        onChange={handleModelChange}
                                        disabled={!serverStatus}
                                    >
                                        <option value=""></option>
                                        <option value="ChatGPT">ChatGPT</option>
                                        <option value="Bard">Bard</option>
                                        <option value="Meta AI">Meta AI</option>
                                    </select>

                                    {/*{selectedModel && (
                                        <div className="mt-2 px-1">
                                            <p>Selected Model: {selectedModel}</p>
                                        </div>
                                    )} */}
                                </div>

                                

                                {/* Textbox and Submit Button */}
                                <form onSubmit={handlePromptSubmit}>
                                    <textarea
                                        value={promptValue}
                                        onChange={handlePromptChange}
                                        className="block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                        placeholder="Enter your prompt"
                                        disabled={!serverStatus}
                                        rows="4"
                                    />

                                    <button
                                        type="submit"
                                        className= {loading || !serverStatus || error ? "mt-2 bg-gray-500 text-white font-bold py-2 px-4 w-full rounded" : "mt-2 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 w-full rounded"}
                                        disabled={loading || !serverStatus || error}
                                    >
                                        {loading ? 'Loading...' : 'Submit'}
                                    </button>
                                </form>
                            </div>
                            { error && (
                                <div className="bg-gray-200 p-4 rounded-lg mt-4">
                                    <p className="text-red-500 font-semibold text-center">{error}</p>
                                </div>
                            )}
                        </div>

                        <div className="w-3/4 ml-4 flex">
                            {/* Right-aligned section */}
                            <div className="p-4 bg-white shadow-md rounded-lg w-full h-96 overflow-auto">
                                {aiResult && (
                                    <div className="mt-4">
                                        <p><b>{selectedModel}</b>: {aiResult['response']}</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
